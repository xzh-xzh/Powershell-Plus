<Window x:Class="PowerShellPlus.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:PowerShellPlus.ViewModels"
        xmlns:controls="clr-namespace:PowerShellPlus.Controls"
        mc:Ignorable="d"
        Title="PowerShell Plus - AI 增强终端" 
        Height="700" Width="1200"
        MinHeight="500" MinWidth="800"
        WindowStartupLocation="CenterScreen"
        Background="{StaticResource BackgroundDarkBrush}"
        Loaded="Window_Loaded"
        Closing="Window_Closing">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
    </Window.Resources>

    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="*" MinWidth="400"/>
            <ColumnDefinition Width="3"/>
            <ColumnDefinition Width="380" MinWidth="300" MaxWidth="500"/>
        </Grid.ColumnDefinitions>

        <!-- 左侧：终端区域 -->
        <Grid Grid.Column="0" Background="{StaticResource BackgroundDarkBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- 终端标题栏 -->
            <Border Grid.Row="0" Background="{StaticResource BackgroundMediumBrush}" Padding="16,12">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>
                    
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <TextBlock Text="⚡" FontSize="18" VerticalAlignment="Center" Margin="0,0,10,0"/>
                        <TextBlock x:Name="TerminalTitle"
                                   Text="PowerShell Terminal" 
                                   Foreground="{StaticResource TextPrimaryBrush}" 
                                   FontSize="15" FontWeight="SemiBold"
                                   VerticalAlignment="Center"/>
                    </StackPanel>
                    
                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="🧹 清屏" 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Padding="12,6"
                                Click="ClearTerminal_Click"
                                ToolTip="清空终端输出"/>
                        <Button Content="⚙️ 设置" 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Padding="12,6"
                                Margin="8,0,0,0"
                                Click="OpenSettings_Click"
                                ToolTip="打开设置"/>
                    </StackPanel>
                </Grid>
            </Border>

            <!-- WebView2 终端区域 -->
            <controls:WebTerminalControl x:Name="TerminalControl" 
                                          Grid.Row="1"
                                          TerminalReady="TerminalControl_TerminalReady"
                                          TitleChanged="TerminalControl_TitleChanged"
                                          ProcessExited="TerminalControl_ProcessExited"/>

            <!-- 底部状态栏 -->
            <Border Grid.Row="2" Background="{StaticResource BackgroundMediumBrush}" Padding="12,8">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                        <Ellipse x:Name="StatusIndicator" 
                                 Width="8" Height="8" 
                                 Fill="#10b981" 
                                 Margin="0,0,8,0"/>
                        <TextBlock x:Name="StatusText"
                                   Text="💡 点击终端区域开始输入 | 100% 原生 PowerShell 体验"
                                   Foreground="{StaticResource TextMutedBrush}"
                                   FontFamily="Cascadia Code, Consolas"
                                   FontSize="12"
                                   VerticalAlignment="Center"/>
                    </StackPanel>

                    <StackPanel Grid.Column="1" Orientation="Horizontal">
                        <Button Content="⏹ 中断" 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Padding="10,4"
                                FontSize="12"
                                Click="InterruptCommand_Click"
                                ToolTip="发送 Ctrl+C 中断当前命令"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- 分隔条 -->
        <GridSplitter Grid.Column="1" 
                      Width="3" 
                      HorizontalAlignment="Stretch"
                      Background="{StaticResource BorderBrush}"
                      Cursor="SizeWE"/>

        <!-- 右侧：AI 助手面板 -->
        <Grid Grid.Column="2" Background="{StaticResource BackgroundMediumBrush}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- AI 面板标题 -->
            <Border Grid.Row="0" Background="#1F2937" Padding="16,14">
                <StackPanel Orientation="Horizontal">
                    <Border Background="{StaticResource AccentGreenBrush}" 
                            CornerRadius="12" Width="24" Height="24"
                            Margin="0,0,10,0">
                        <TextBlock Text="✨" FontSize="12" 
                                   HorizontalAlignment="Center" 
                                   VerticalAlignment="Center"/>
                    </Border>
                    <TextBlock Text="AI Command Assistant" 
                               Foreground="{StaticResource TextPrimaryBrush}"
                               FontSize="15" FontWeight="SemiBold"
                               VerticalAlignment="Center"/>
                </StackPanel>
            </Border>

            <!-- 对话历史区域 -->
            <ScrollViewer Grid.Row="1" 
                          x:Name="ChatScrollViewer"
                          VerticalScrollBarVisibility="Auto"
                          Padding="12">
                <ItemsControl ItemsSource="{Binding ChatHistory}">
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,0,0,12">
                                <StackPanel>
                                    <!-- 用户消息 -->
                                    <Border Visibility="{Binding IsUser, Converter={StaticResource BoolToVis}}"
                                            Background="{StaticResource AccentBlueBrush}"
                                            CornerRadius="12,12,4,12"
                                            Padding="12,10"
                                            HorizontalAlignment="Right"
                                            MaxWidth="280">
                                        <TextBlock Text="{Binding Content}" 
                                                   Foreground="White"
                                                   TextWrapping="Wrap"
                                                   FontSize="13"/>
                                    </Border>

                                    <!-- AI 消息 -->
                                    <StackPanel Visibility="{Binding IsAssistant, Converter={StaticResource BoolToVis}}">
                                        <Border Background="{StaticResource BackgroundLightBrush}"
                                                CornerRadius="12,12,12,4"
                                                Padding="12,10"
                                                HorizontalAlignment="Left"
                                                MaxWidth="320">
                                            <StackPanel>
                                                <TextBlock Text="{Binding Content}" 
                                                           Foreground="{StaticResource TextSecondaryBrush}"
                                                           TextWrapping="Wrap"
                                                           FontSize="13"/>
                                                
                                                <!-- 加载指示器 -->
                                                <StackPanel Orientation="Horizontal" 
                                                            Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                                                            Margin="0,8,0,0">
                                                    <Ellipse Width="6" Height="6" Fill="{StaticResource AccentBlueBrush}" Margin="0,0,4,0"/>
                                                    <Ellipse Width="6" Height="6" Fill="{StaticResource AccentBlueBrush}" Margin="0,0,4,0" Opacity="0.6"/>
                                                    <Ellipse Width="6" Height="6" Fill="{StaticResource AccentBlueBrush}" Opacity="0.3"/>
                                                </StackPanel>

                                                <!-- 生成的命令 -->
                                                <Border Visibility="{Binding HasCommand, Converter={StaticResource BoolToVis}}"
                                                        Background="#1A1A2E"
                                                        CornerRadius="6"
                                                        Padding="10"
                                                        Margin="0,10,0,0">
                                                    <TextBlock Text="{Binding GeneratedCommand}" 
                                                               Foreground="#7DD3FC"
                                                               FontFamily="Cascadia Code, Consolas"
                                                               FontSize="12"
                                                               TextWrapping="Wrap"/>
                                                </Border>
                                            </StackPanel>
                                        </Border>
                                    </StackPanel>
                                </StackPanel>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </ScrollViewer>

            <!-- 命令预览区 -->
            <Border Grid.Row="2" 
                    Visibility="{Binding HasGeneratedCommand, Converter={StaticResource BoolToVis}}"
                    Background="{StaticResource BackgroundDarkBrush}"
                    Margin="12,0,12,12"
                    CornerRadius="10">
                <StackPanel>
                    <!-- 预览标题 -->
                    <Border Background="#1F2937" Padding="12,10" CornerRadius="10,10,0,0">
                        <TextBlock Text="📋 命令预览" 
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   FontSize="12" FontWeight="SemiBold"/>
                    </Border>
                    
                    <!-- 命令代码 -->
                    <TextBox Text="{Binding GeneratedCommand, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             Style="{StaticResource CodePreviewStyle}"
                             BorderThickness="0"
                             MinHeight="60"
                             MaxHeight="120"/>
                    
                    <!-- 操作按钮 -->
                    <Border Background="#1F2937" Padding="10" CornerRadius="0,0,10,10">
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <Button Grid.Column="0" 
                                    Content="▶ 执行命令" 
                                    Style="{StaticResource PrimaryButtonStyle}"
                                    Command="{Binding ExecuteCommandCommand}"
                                    IsEnabled="{Binding IsExecuting, Converter={StaticResource InverseBoolConverter}}"
                                    HorizontalAlignment="Stretch"
                                    Margin="0,0,8,0"/>
                            
                            <Button Grid.Column="1" 
                                    Content="📋" 
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    Command="{Binding CopyCommandCommand}"
                                    ToolTip="复制到剪贴板"
                                    Padding="10,8"/>
                            
                            <Button Grid.Column="2" 
                                    Content="✏️" 
                                    Style="{StaticResource SecondaryButtonStyle}"
                                    ToolTip="编辑命令（直接在上方编辑）"
                                    Padding="10,8"
                                    Margin="6,0,0,0"/>
                        </Grid>
                    </Border>
                </StackPanel>
            </Border>

            <!-- 快捷命令区 -->
            <Border Grid.Row="3" Padding="12,0,12,12">
                <StackPanel>
                    <!-- 标题栏 -->
                    <Grid Margin="0,0,0,10">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="⭐ 常用命令" 
                                   FontSize="12" FontWeight="SemiBold"
                                   Foreground="{StaticResource TextSecondaryBrush}"
                                   VerticalAlignment="Center"/>
                        <Button Grid.Column="1" 
                                Content="⚙️" 
                                Style="{StaticResource SecondaryButtonStyle}"
                                Padding="8,4"
                                FontSize="12"
                                ToolTip="管理常用命令"
                                Click="ManageCommands_Click"/>
                    </Grid>
                    <!-- 命令列表 -->
                    <ItemsControl ItemsSource="{Binding QuickCommands}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <WrapPanel/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Button Style="{StaticResource QuickCommandButtonStyle}"
                                        Command="{Binding DataContext.ExecuteQuickCommandCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                        CommandParameter="{Binding}"
                                        ToolTip="{Binding Description}"
                                        Margin="0,0,6,6">
                                    <StackPanel Orientation="Horizontal">
                                        <TextBlock Text="{Binding Icon}" Margin="0,0,6,0"/>
                                        <TextBlock Text="{Binding Name}" Foreground="{StaticResource TextPrimaryBrush}"/>
                                    </StackPanel>
                                </Button>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- 输入区域 -->
            <Border Grid.Row="4" Background="#1F2937" Padding="12">
                <StackPanel>
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <TextBox x:Name="UserInputBox"
                                 Style="{StaticResource ModernTextBoxStyle}"
                                 Text="{Binding UserInput, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 AcceptsReturn="False"
                                 KeyDown="UserInputBox_KeyDown">
                            <TextBox.Resources>
                                <Style TargetType="Border">
                                    <Setter Property="CornerRadius" Value="8"/>
                                </Style>
                            </TextBox.Resources>
                        </TextBox>
                        
                        <!-- Placeholder -->
                        <TextBlock Text="描述你想执行的操作..."
                                   Foreground="{StaticResource TextMutedBrush}"
                                   FontSize="14"
                                   IsHitTestVisible="False"
                                   Margin="14,0,0,0"
                                   VerticalAlignment="Center">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding Text, ElementName=UserInputBox}" Value="">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>

                        <Button Grid.Column="1" 
                                Style="{StaticResource PrimaryButtonStyle}"
                                Command="{Binding SendMessageCommand}"
                                IsEnabled="{Binding IsGenerating, Converter={StaticResource InverseBoolConverter}}"
                                Padding="14,10"
                                Margin="10,0,0,0">
                            <TextBlock Text="➤" FontSize="16"/>
                        </Button>
                    </Grid>
                    
                    <!-- API 未配置警告 -->
                    <Border Visibility="{Binding IsApiConfigured, Converter={StaticResource InverseBoolToVisConverter}}"
                            Background="{StaticResource AccentOrangeBrush}"
                            CornerRadius="6"
                            Padding="10,8"
                            Margin="0,10,0,0">
                        <TextBlock Text="⚠️ 请先在设置中配置 API Key" 
                                   Foreground="White"
                                   FontSize="12"
                                   TextAlignment="Center"/>
                    </Border>
                </StackPanel>
            </Border>
        </Grid>
    </Grid>
</Window>
