<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerShell Terminal</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0c0c0c;
        }
        
        #terminal {
            width: 100%;
            height: 100%;
        }
        
        /* 自定义滚动条 */
        .xterm-viewport::-webkit-scrollbar {
            width: 10px;
        }
        
        .xterm-viewport::-webkit-scrollbar-track {
            background: #1a1a1a;
        }
        
        .xterm-viewport::-webkit-scrollbar-thumb {
            background: #3a3a3a;
            border-radius: 5px;
        }
        
        .xterm-viewport::-webkit-scrollbar-thumb:hover {
            background: #4a4a4a;
        }
    </style>
</head>
<body>
    <div id="terminal"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-web-links@0.11.0/lib/addon-web-links.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-unicode11@0.8.0/lib/addon-unicode11.min.js"></script>
    
    <script>
        // 终端配置
        const terminalConfig = {
            cursorBlink: true,
            cursorStyle: 'block',
            fontSize: 14,
            fontFamily: '"Cascadia Code", "Cascadia Mono", Consolas, "Courier New", monospace',
            lineHeight: 1.2,
            letterSpacing: 0,
            theme: {
                background: '#0c0c0c',
                foreground: '#cccccc',
                cursor: '#ffffff',
                cursorAccent: '#0c0c0c',
                selectionBackground: '#264f78',
                selectionForeground: '#ffffff',
                selectionInactiveBackground: '#3a3d41',
                black: '#0c0c0c',
                red: '#c50f1f',
                green: '#13a10e',
                yellow: '#c19c00',
                blue: '#0037da',
                magenta: '#881798',
                cyan: '#3a96dd',
                white: '#cccccc',
                brightBlack: '#767676',
                brightRed: '#e74856',
                brightGreen: '#16c60c',
                brightYellow: '#f9f1a5',
                brightBlue: '#3b78ff',
                brightMagenta: '#b4009e',
                brightCyan: '#61d6d6',
                brightWhite: '#f2f2f2'
            },
            allowProposedApi: true,
            scrollback: 10000,
            tabStopWidth: 4,
            windowsMode: true
        };

        // 创建终端实例
        const terminal = new Terminal(terminalConfig);
        
        // 加载插件
        const fitAddon = new FitAddon.FitAddon();
        const webLinksAddon = new WebLinksAddon.WebLinksAddon();
        const unicode11Addon = new Unicode11Addon.Unicode11Addon();
        
        terminal.loadAddon(fitAddon);
        terminal.loadAddon(webLinksAddon);
        terminal.loadAddon(unicode11Addon);
        terminal.unicode.activeVersion = '11';

        // 打开终端
        const container = document.getElementById('terminal');
        terminal.open(container);
        
        // 初始适配大小
        setTimeout(() => {
            fitAddon.fit();
            notifySize();
        }, 100);

        // 窗口大小变化时重新适配
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                fitAddon.fit();
                notifySize();
            }, 50);
        });

        // 通知 C# 终端尺寸变化
        function notifySize() {
            const cols = terminal.cols;
            const rows = terminal.rows;
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'resize',
                    cols: cols,
                    rows: rows
                });
            }
        }

        // 处理用户输入
        terminal.onData(data => {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'input',
                    data: data
                });
            }
        });

        // 处理二进制数据
        terminal.onBinary(data => {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'binary',
                    data: data
                });
            }
        });

        // 处理标题变化
        terminal.onTitleChange(title => {
            if (window.chrome && window.chrome.webview) {
                window.chrome.webview.postMessage({
                    type: 'title',
                    title: title
                });
            }
        });

        // 从 C# 接收数据并写入终端
        function writeToTerminal(data) {
            terminal.write(data);
        }

        // 从 C# 接收数据（Base64 编码）
        function writeBase64ToTerminal(base64Data) {
            // 使用 TextDecoder 正确解码 UTF-8
            const binaryString = atob(base64Data);
            const bytes = new Uint8Array(binaryString.length);
            for (let i = 0; i < binaryString.length; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            const text = new TextDecoder('utf-8').decode(bytes);
            terminal.write(text);
        }

        // 清屏
        function clearTerminal() {
            terminal.clear();
        }

        // 重置终端
        function resetTerminal() {
            terminal.reset();
        }

        // 聚焦终端
        function focusTerminal() {
            terminal.focus();
        }

        // 获取当前尺寸
        function getTerminalSize() {
            return {
                cols: terminal.cols,
                rows: terminal.rows
            };
        }

        // 调整字体大小
        function setFontSize(size) {
            terminal.options.fontSize = size;
            fitAddon.fit();
            notifySize();
        }

        // 设置主题
        function setTheme(theme) {
            terminal.options.theme = theme;
        }

        // 滚动到底部
        function scrollToBottom() {
            terminal.scrollToBottom();
        }

        // 通知 C# 终端已就绪
        if (window.chrome && window.chrome.webview) {
            window.chrome.webview.postMessage({
                type: 'ready',
                cols: terminal.cols,
                rows: terminal.rows
            });
        }

        // 自动聚焦
        terminal.focus();

        // 监听点击事件以获取焦点
        container.addEventListener('click', () => {
            terminal.focus();
        });

        console.log('Terminal initialized successfully');
    </script>
</body>
</html>



